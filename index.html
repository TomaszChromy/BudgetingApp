<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BudgetingApp â€“ Prosty budÅ¼et domowy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb; /* gray-200 */
      --brand: #22c55e; /* green-500 */
      --danger: #ef4444; /* red-500 */
      --warn: #f59e0b; /* amber-500 */
      --ring: rgba(34, 197, 94, .35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(180deg, #0b1220 0%, #0f172a 100%);
      color: var(--text);
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    h1 { margin: 0; font-size: 20px; font-weight: 600; letter-spacing: .2px; }
    .toolbar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    select, input, button, textarea {
      background: #0b1220; border: 1px solid #1f2937; color: var(--text);
      padding: 8px 10px; border-radius: 10px; outline: none;
    }
    select:focus, input:focus, textarea:focus { box-shadow: 0 0 0 4px var(--ring); border-color: #334155; }
    .btn { background: #1f2937; border: 1px solid #374151; cursor: pointer; }
    .btn:hover { background: #273244; }
    .btn-outline { background: transparent; }
    .btn-danger { background: #3f1e1e; border-color: #5c2a2a; color: #fecaca; }
    .pill { font-size: 12px; padding: 2px 8px; border-radius: 999px; }
    .pill.income { background: rgba(34,197,94,.1); border: 1px solid rgba(34,197,94,.4); color: #bbf7d0; }
    .pill.expense { background: rgba(239,68,68,.1); border: 1px solid rgba(239,68,68,.4); color: #fecaca; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: var(--panel); border: 1px solid #1f2937; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 24px rgba(0,0,0,.35); }
    .card .content { padding: 16px; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; align-items: end; }
    .col { display: flex; flex-direction: column; gap: 6px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #1f2937; text-align: left; }
    th { position: sticky; top: 0; background: #0b1220; z-index: 1; }
    .right { text-align: right; }
    .muted { color: var(--muted); }
    .list-scroll { max-height: 420px; overflow: auto; border: 1px solid #1f2937; border-radius: 12px; }
    .kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .kpi { background: #0b1220; border: 1px solid #1f2937; border-radius: 14px; padding: 14px; }
    .spacer { height: 8px; }
    @media (max-width: 960px) { .grid { grid-template-columns: 1fr; } }
    @media print {
      header .toolbar { display: none; }
      .grid { grid-template-columns: 1fr; }
      .card { box-shadow: none; border: 0; background: #fff; }
      body { background: #fff; color: #000; }
      .list-scroll { max-height: unset; border: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸ’¸ BudgetingApp</h1>
      <div class="toolbar">
        <label class="muted">Portfel</label>
        <select id="walletSelect" title="Wybierz portfel"></select>
        <button id="addWalletBtn" class="btn btn-outline" title="Dodaj portfel">+ Portfel</button>
        <button id="delWalletBtn" class="btn btn-danger" title="UsuÅ„ portfel">UsuÅ„</button>

        <select id="currencySelect" title="Waluta portfela">
          <option value="PLN">PLN</option>
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
        </select>

        <span style="width:12px;display:inline-block"></span>
        <button id="exportBtn" class="btn btn-outline" title="Eksport do JSON">Eksport</button>
        <label class="btn btn-outline" for="importFile" title="Import JSON">Import JSON</label>
        <input id="importFile" type="file" accept="application/json" class="sr-only" style="position:absolute;left:-9999px">
        <button id="resetBtn" class="btn btn-danger" title="UsuÅ„ wszystkie dane">WyczyÅ›Ä‡</button>
      </div>
    </header>

    <section class="grid">
      <div class="stack">
        <div class="card">
          <div class="content">
            <h3>Dodaj / edytuj transakcjÄ™</h3>
            <div class="spacer"></div>
            <form id="txForm" class="row" autocomplete="off">
              <div class="col" style="grid-column: span 3">
                <label for="date">Data</label>
                <input type="date" id="date" required />
              </div>
              <div class="col" style="grid-column: span 3">
                <label for="type">Typ</label>
                <select id="type">
                  <option value="expense">Wydatek</option>
                  <option value="income">PrzychÃ³d</option>
                </select>
              </div>
              <div class="col" style="grid-column: span 3">
                <label for="category">Kategoria</label>
                <input id="category" list="categoryList" placeholder="np. Jedzenie" />
                <datalist id="categoryList"></datalist>
              </div>
              <div class="col" style="grid-column: span 3">
                <label for="amount">Kwota</label>
                <input id="amount" type="number" step="0.01" placeholder="0.00" required />
              </div>
              <div class="col" style="grid-column: span 12">
                <label for="note">Opis (opcjonalnie)</label>
                <textarea id="note" rows="2" placeholder="Notatka"></textarea>
              </div>
              <input type="hidden" id="editId" />
              <div class="col" style="grid-column: span 12; display:flex; gap:8px; justify-content:flex-end">
                <button type="submit" class="btn">Zapisz</button>
                <button type="button" id="cancelEdit" class="btn btn-outline">Anuluj</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="content">
            <h3>Transakcje</h3>
            <div class="row">
              <div class="col" style="grid-column: span 3">
                <label>Filtr tekst</label>
                <input id="q" placeholder="Szukaj w opisie/kategorii" />
              </div>
              <div class="col" style="grid-column: span 3">
                <label>MiesiÄ…c</label>
                <input id="m" type="month" />
              </div>
              <div class="col" style="grid-column: span 3">
                <label>Typ</label>
                <select id="fType">
                  <option value="">Wszystko</option>
                  <option value="income">PrzychÃ³d</option>
                  <option value="expense">Wydatek</option>
                </select>
              </div>
              <div class="col" style="grid-column: span 3"></div>
            </div>

            <div class="spacer"></div>
            <div class="list-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Typ</th>
                    <th>Kategoria</th>
                    <th>Opis</th>
                    <th class="right">Kwota</th>
                    <th class="right">Akcje</th>
                  </tr>
                </thead>
                <tbody id="rows"></tbody>
              </table>
            </div>
            <div class="spacer"></div>
            <div class="muted right" id="visibleSum"></div>
          </div>
        </div>
      </div>

      <div class="stack">
        <div class="card">
          <div class="content">
            <h3>WskaÅºniki</h3>
            <div class="kpis">
              <div class="kpi">
                <div class="muted">Przychody</div>
                <div id="kpiIncome" style="font-size:22px;font-weight:600">0</div>
              </div>
              <div class="kpi">
                <div class="muted">Wydatki</div>
                <div id="kpiExpense" style="font-size:22px;font-weight:600">0</div>
              </div>
              <div class="kpi">
                <div class="muted">Bilans</div>
                <div id="kpiBalance" style="font-size:22px;font-weight:600">0</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="content">
            <h3>Wykres kategorii (miesiÄ…c)</h3>
            <canvas id="catChart" height="220"></canvas>
          </div>
        </div>
      </div>
    </section>
  </div>

<script>
(function(){
  const STORAGE_KEY = 'budgetingApp.v2';

  const state = {
    tx: [], // {id, date, type, category, amount, note, walletId}
    wallets: [], // {id, name, currency}
    activeWalletId: '',
  };

  // ======= Storage =======
  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const data = JSON.parse(raw);
      if (Array.isArray(data.tx)) state.tx = data.tx;
      if (Array.isArray(data.wallets)) state.wallets = data.wallets;
      if (data.activeWalletId) state.activeWalletId = data.activeWalletId;
    } catch (e) { console.warn('BÅ‚Ä…d odczytu', e); }
  }
  function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }

  // ======= Utils =======
  const $ = (sel) => document.querySelector(sel);
  const uid = () => Math.random().toString(36).slice(2,10);
  const today = () => new Date().toISOString().slice(0,10);

  // ======= Wallets & currency helpers =======
  function currentWallet() {
    return state.wallets.find(w => w.id === state.activeWalletId) || state.wallets[0];
  }
  function ensureWallets() {
    if (!Array.isArray(state.wallets) || state.wallets.length === 0) {
      const def = { id: uid(), name: 'MÃ³j portfel', currency: 'PLN' };
      state.wallets = [def];
      state.activeWalletId = def.id;
      state.tx = state.tx.map(t => ({ ...t, walletId: t.walletId || def.id }));
      save();
    } else {
      const wid = state.activeWalletId || state.wallets[0]?.id;
      state.activeWalletId = wid;
      state.tx = state.tx.map(t => ({ ...t, walletId: t.walletId || wid }));
    }
  }
  function refreshWalletUI() {
    const sel = el.walletSelect;
    sel.innerHTML = state.wallets.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
    sel.value = state.activeWalletId;
    const cw = currentWallet();
    if (cw && el.currencySelect) el.currencySelect.value = cw.currency;
  }
  function setActiveWallet(id) {
    if (!state.wallets.find(w=>w.id===id)) return;
    state.activeWalletId = id;
    save(); refresh(); refreshWalletUI();
  }
  function addWallet() {
    const name = prompt('Nazwa portfela:', 'Nowy portfel'); if (!name) return;
    const curr = prompt('Waluta (PLN/EUR/USD):', 'PLN'); if (!curr) return;
    const c = curr.toUpperCase();
    if (!['PLN','EUR','USD'].includes(c)) return alert('Waluta musi byÄ‡: PLN, EUR lub USD.');
    const w = { id: uid(), name, currency: c };
    state.wallets.push(w);
    state.activeWalletId = w.id;
    save(); refreshWalletUI(); refresh();
  }
  function delWallet() {
    if (state.wallets.length <= 1) return alert('Musi pozostaÄ‡ przynajmniej jeden portfel.');
    const cw = currentWallet();
    if (!confirm(`UsunÄ…Ä‡ portfel "${cw.name}"?`)) return;
    // UsuÅ„ transakcje tego portfela
    state.tx = state.tx.filter(t => t.walletId !== cw.id);
    // UsuÅ„ portfel
    state.wallets = state.wallets.filter(w => w.id !== cw.id);
    state.activeWalletId = state.wallets[0].id;
    save(); refreshWalletUI(); refresh();
  }

  // Format waluty wg portfela
  function fmt(n, currency) {
    const c = currency || (currentWallet()?.currency || 'PLN');
    return new Intl.NumberFormat('pl-PL', { style: 'currency', currency: c, minimumFractionDigits: 2 }).format(Number(n) || 0);
  }

  // ======= Elements =======
  const el = {
    form: document.getElementById('txForm'),
    date: document.getElementById('date'),
    type: document.getElementById('type'),
    category: document.getElementById('category'),
    amount: document.getElementById('amount'),
    note: document.getElementById('note'),
    editId: document.getElementById('editId'),
    rows: document.getElementById('rows'),
    q: document.getElementById('q'),
    m: document.getElementById('m'),
    fType: document.getElementById('fType'),
    visibleSum: document.getElementById('visibleSum'),
    catChart: document.getElementById('catChart'),
    kpiIncome: document.getElementById('kpiIncome'),
    kpiExpense: document.getElementById('kpiExpense'),
    kpiBalance: document.getElementById('kpiBalance'),
    catList: document.getElementById('categoryList'),
    exportBtn: document.getElementById('exportBtn'),
    importFile: document.getElementById('importFile'),
    resetBtn: document.getElementById('resetBtn'),
    walletSelect: document.getElementById('walletSelect'),
    addWalletBtn: document.getElementById('addWalletBtn'),
    delWalletBtn: document.getElementById('delWalletBtn'),
    currencySelect: document.getElementById('currencySelect'),
  };

  // ======= Category datalist =======
  function refreshCategories() {
    const cats = [...new Set(state.tx.filter(t => t.walletId === state.activeWalletId).map(t => t.category).filter(Boolean))];
    el.catList.innerHTML = cats.map(c => `<option value="${c}">`).join('');
  }

  // ======= Filters =======
  function matchFilters(t) {
    if (t.walletId !== state.activeWalletId) return false;
    const q = (el.q.value || '').trim().toLowerCase();
    const okQ = !q || (t.category||'').toLowerCase().includes(q) || (t.note||'').toLowerCase().includes(q);
    const m = (el.m.value || '').trim();
    const okM = !m || (t.date || '').slice(0,7) === m;
    const ft = el.fType.value;
    const okT = !ft || t.type === ft;
    return okQ && okM && okT;
  }

  // ======= Rendering =======
  function renderTable() {
    const filtered = state.tx.filter(matchFilters).sort((a,b) => (b.date||'').localeCompare(a.date||''));
    el.rows.innerHTML = filtered.map(t => `
      <tr>
        <td>${t.date || ''}</td>
        <td><span class="pill ${t.type==='income'?'income':'expense'}">${t.type==='income'?'PrzychÃ³d':'Wydatek'}</span></td>
        <td>${t.category || ''}</td>
        <td class="muted">${(t.note || '')}</td>
        <td class="right">${fmt(t.amount)}</td>
        <td class="right">
          <button class="btn btn-outline" title="Edytuj" aria-label="Edytuj" onclick="editTx('${t.id}')">Edytuj</button>
          <button class="btn btn-danger" title="UsuÅ„" aria-label="UsuÅ„" onclick="deleteTx('${t.id}')">UsuÅ„</button>
        </td>
      </tr>
    `).join('');
    el.visibleSum.textContent = 'Suma widocznych: ' + fmt(filtered.reduce((s,t)=>s+Number(t.amount||0),0));
  }

  let catChart;
  function renderCharts() {
    const m = el.m.value || (new Date().toISOString().slice(0,7));
    const monthTx = state.tx.filter(t => t.walletId===state.activeWalletId && t.type==='expense' && (t.date||'').slice(0,7)===m);
    const byCat = monthTx.reduce((acc,t) => (acc[t.category] = (acc[t.category]||0)+Number(t.amount||0), acc), {});
    const labels = Object.keys(byCat);
    const data = Object.values(byCat);
    if (catChart) catChart.destroy();
    catChart = new Chart(el.catChart.getContext('2d'), {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Wydatki', data }] },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  function renderKPIs() {
    const walletTx = state.tx.filter(t => t.walletId === state.activeWalletId);
    const inc = walletTx.filter(t=>t.type==='income').reduce((s,t)=>s+Number(t.amount||0),0);
    const exp = walletTx.filter(t=>t.type==='expense').reduce((s,t)=>s+Number(t.amount||0),0);
    const bal = inc - exp;
    el.kpiIncome.textContent = fmt(inc);
    el.kpiExpense.textContent = fmt(exp);
    el.kpiBalance.textContent = fmt(bal);
  }

  function refresh() {
    refreshCategories();
    renderTable();
    renderKPIs();
    renderCharts();
  }

  // ======= CRUD =======
  function clearForm() {
    el.editId.value = '';
    el.date.value = today();
    el.type.value = 'expense';
    el.category.value = '';
    el.amount.value = '';
    el.note.value = '';
  }
  function addTx(e) {
    e.preventDefault();
    const id = el.editId.value || uid();
    const t = {
      id,
      date: el.date.value || today(),
      type: el.type.value,
      category: el.category.value || '',
      amount: Number(el.amount.value || 0),
      note: el.note.value || '',
      walletId: state.activeWalletId
    };
    if (el.editId.value) {
      state.tx = state.tx.map(x => x.id===id ? t : x);
    } else {
      state.tx.push(t);
    }
    save(); refresh(); clearForm();
  }
  function editTx(id) {
    const t = state.tx.find(x => x.id===id); if (!t) return;
    el.editId.value = t.id;
    el.date.value = t.date || today();
    el.type.value = t.type;
    el.category.value = t.category || '';
    el.amount.value = t.amount || 0;
    el.note.value = t.note || '';
    el.date.focus();
  }
  function deleteTx(id) {
    if (!confirm('UsunÄ…Ä‡ transakcjÄ™?')) return;
    state.tx = state.tx.filter(x => x.id !== id);
    save(); refresh();
  }

  // ======= Wiring =======
  const expose = { editTx, deleteTx };
  Object.assign(window, expose);

  el.form.addEventListener('submit', addTx);
  $('#cancelEdit').addEventListener('click', (e)=>{ e.preventDefault(); clearForm(); });

  [el.q, el.m, el.fType].forEach(c => c.addEventListener('input', ()=>{ renderTable(); renderCharts(); }));

  el.exportBtn.addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'budgetingapp-export.json'; a.click(); URL.revokeObjectURL(a.href);
  });

  el.importFile.addEventListener('change', (e) => {
    const file = e.target.files?.[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (!data || !Array.isArray(data.tx)) throw new Error('NieprawidÅ‚owy plik');
        state.tx = data.tx;
        // waÅ¼ne: po imporcie upewnij siÄ™, Å¼e sÄ… portfele i przypisz walletId
        ensureWallets();
        refreshWalletUI();
        save();
        refresh();
      } catch (err) { alert('Nie udaÅ‚o siÄ™ zaimportowaÄ‡: ' + err.message); }
    };
    reader.readAsText(file);
    e.target.value = '';
  });

  el.resetBtn.addEventListener('click', () => {
    if (!confirm('UsunÄ…Ä‡ wszystkie dane?')) return;
    state.tx = [];
    state.wallets = [];
    state.activeWalletId = '';
    save(); load(); ensureWallets(); refreshWalletUI(); refresh();
  });

  el.walletSelect.addEventListener('change', (e) => setActiveWallet(e.target.value));
  el.addWalletBtn.addEventListener('click', addWallet);
  el.delWalletBtn.addEventListener('click', delWallet);

  el.currencySelect.addEventListener('change', (e) => {
    const cw = currentWallet(); if (!cw) return;
    cw.currency = e.target.value;
    save(); refresh();
  });

  // ======= Init =======
  load(); ensureWallets(); refreshWalletUI();
  clearForm(); el.date.value = today();
  refresh();
})();
</script>
</body>
</html>
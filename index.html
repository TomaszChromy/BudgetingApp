<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BudgetingApp – Prosty budżet domowy</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb; /* gray-200 */
      --brand: #22c55e; /* green-500 */
      --danger: #ef4444; /* red-500 */
      --warn: #f59e0b; /* amber-500 */
      --ring: rgba(34, 197, 94, .35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
      background: radial-gradient(1200px 600px at 80% -10%, rgba(34,197,94,.08), transparent 60%), var(--bg);
      color: var(--text);
    }
    .container { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px; }
    .title { font-weight: 700; font-size: 22px; letter-spacing: 0.2px; }
    .subtitle { color: var(--muted); font-weight: 500; font-size: 13px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; }
    button, .btn {
      background: #1f2937; color: var(--text); border: 1px solid #1f2937; padding: 10px 12px; border-radius: 12px; font-weight: 600; cursor: pointer;
      transition: transform .05s ease, border-color .2s ease, background .2s ease; font-size: 13px; letter-spacing: .2px;
    }
    button:hover { border-color: var(--brand); }
    button:active { transform: translateY(1px); }
    .btn-outline { background: transparent; border-color: #334155; }
    .btn-danger { background: #331d1d; border-color: #7f1d1d; color: #fecaca; }
    .grid { display: grid; grid-template-columns: 1.05fr .95fr; gap: 16px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card { background: linear-gradient(180deg, rgba(148,163,184,.04), transparent), #0b1220; border: 1px solid #1f2937; border-radius: 16px; box-shadow: 0 1px 0 rgba(255,255,255,.03) inset; }
    .card h3 { margin: 0; font-size: 14px; letter-spacing: .3px; color: var(--muted); font-weight: 600; }
    .card .content { padding: 16px; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .row > * { min-width: 0; }
    input, select { width: 100%; background: #0b1220; color: var(--text); border: 1px solid #233046; padding: 10px 12px; border-radius: 12px; font: inherit; outline: none; }
    input:focus, select:focus { border-color: var(--brand); box-shadow: 0 0 0 4px var(--ring); }
    label { font-size: 12px; color: var(--muted); margin-bottom: 6px; display: inline-block; }
    .kpi { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 14px 16px; border-radius: 14px; border: 1px solid #1f2937; background: #0b1220; }
    .kpi strong { font-size: 18px; }
    .kpi small { color: var(--muted); }
    .kpi.negative strong { color: var(--danger); }
    .kpi.positive strong { color: var(--brand); }
    table { width: 100%; border-collapse: collapse; }
    th, td { font-size: 13px; padding: 10px 12px; border-bottom: 1px dashed #1f2937; vertical-align: middle; }
    th { color: var(--muted); text-align: left; font-weight: 600; }
    tr:hover td { background: rgba(148,163,184,.05); }
    .right { text-align: right; }
    .pill { padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #334155; color: #cbd5e1; }
    .pill.income { border-color: #14532d; background: rgba(34,197,94,.08); color: #bbf7d0; }
    .pill.expense { border-color: #7f1d1d; background: rgba(239,68,68,.08); color: #fecaca; }
    .list-scroll { max-height: 420px; overflow: auto; border-radius: 12px; border: 1px solid #1f2937; }
    .muted { color: var(--muted); }
    .inline { display: inline-flex; align-items: center; gap: 6px; }
    .danger { color: #fecaca; }
    .spacer { height: 10px; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <div class="title">BudgetingApp</div>
        <div class="subtitle">Prosty budżet: transakcje, kategorie, raporty. Dane w przeglądarce (LocalStorage).</div>
      </div>
      <div class="toolbar">
        <button id="exportBtn" title="Eksport do JSON">Eksport</button>
        <button id="exportCsvAllBtn" class="btn btn-outline" title="Eksport wszystkich portfeli do CSV">CSV (wszystkie)</button>
        <label class="btn btn-outline" for="importFile">Import JSON<input id="importFile" type="file" accept="application/json" class="sr-only"></label>
        <button id="resetBtn" class="btn-danger" title="Usuń wszystkie dane">Wyczyść</button>
      </div>
    </header>

    <section class="grid">
      <!-- LEWA: formularz + lista -->
      <div class="stack">
        <div class="card">
          <div class="content">
            <h3>Dodaj / edytuj transakcję</h3>
            <div class="spacer"></div>
            <form id="txForm" class="row" autocomplete="off">
              <div class="col" style="grid-column: span 3">
                <label for="date">Data</label>
                <input type="date" id="date" required />
              </div>
              <div class="col" style="grid-column: span 3">
                <label for="type">Typ</label>
                <select id="type">
                  <option value="expense">Wydatek</option>
                  <option value="income">Przychód</option>
                </select>
              </div>
              <div class="col" style="grid-column: span 3">
                <label for="category">Kategoria</label>
                <input id="category" list="categoryList" placeholder="np. Jedzenie" required />
                <datalist id="categoryList"></datalist>
              </div>
              <div class="col" style="grid-column: span 3">
                <label for="amount">Kwota</label>
                <input type="number" step="0.01" id="amount" placeholder="0.00" required />
              </div>
              <div class="col" style="grid-column: span 12">
                <label for="note">Opis (opcjonalnie)</label>
                <input id="note" placeholder="np. Zakupy weekendowe" />
              </div>
              <input type="hidden" id="editId" />
              <div class="col" style="grid-column: span 12; display:flex; gap: 8px; justify-content: flex-end;">
                <button type="button" id="cancelEdit" class="btn btn-outline" style="display:none">Anuluj</button>
                <button type="submit">Zapisz</button>
              </div>
            </form>
          </div>
        </div>

        <div class="spacer"></div>

        <div class="card">
          <div class="content">
            <div style="display:flex; align-items:center; justify-content: space-between; gap:12px;">
              <h3>Transakcje</h3>
              <div class="inline">
                <label for="month">Miesiąc</label>
                <input type="month" id="month" />
                <label for="search">Szukaj</label>
                <input id="search" placeholder="opis / kategoria" style="width:180px" />
              </div>
            </div>
            <div class="spacer"></div>
            <div class="list-scroll">
              <table id="txTable">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Typ</th>
                    <th>Kategoria</th>
                    <th>Opis</th>
                    <th class="right">Kwota</th>
                    <th class="right">Akcje</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot>
                  <tr>
                    <td colspan="4" class="right"><strong>Suma (widoczne):</strong></td>
                    <td class="right" id="visibleSum">0.00</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- PRAWA: KPI + wykresy -->
      <div class="stack">
        <div class="card"><div class="content">
          <h3>Podsumowanie</h3>
          <div class="spacer"></div>
          <div class="row">
            <div class="kpi positive" style="grid-column: span 4">
              <div>
                <small>Przychody</small>
                <div><strong id="kpiIncome">0,00</strong></div>
              </div>
            </div>
            <div class="kpi negative" style="grid-column: span 4">
              <div>
                <small>Wydatki</small>
                <div><strong id="kpiExpense">0,00</strong></div>
              </div>
            </div>
            <div class="kpi" style="grid-column: span 4">
              <div>
                <small>Bilans</small>
                <div><strong id="kpiBalance">0,00</strong></div>
              </div>
            </div>
          </div>
        </div></div>

        <div class="spacer"></div>

        <div class="card"><div class="content">
          <h3>Wydatki wg kategorii</h3>
          <div class="spacer"></div>
          <canvas id="pie"></canvas>
        </div></div>

        <div class="spacer"></div>

        <div class="card"><div class="content">
          <h3>Trend miesięczny (saldo)</h3>
          <div class="spacer"></div>
          <canvas id="bar"></canvas>
        </div></div>
      </div>
    </section>
  </div>

  <script>
    // ======= Storage & helpers =======
    const STORAGE_KEY = 'budgetingApp.v1';
    const state = {
      tx: [], // {id, date(yyyy-mm-dd), type:'income'|'expense', category, amount:number, note}
    };

    function load() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);
        if (Array.isArray(data.tx)) state.tx = data.tx;
      } catch (e) { console.warn('Błąd odczytu', e); }
    }
    function save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function uid() { return Math.random().toString(36).slice(2, 10); }
    function fmt(n) { return Number(n).toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    // ======= Elements =======
    const el = {
      form: document.getElementById('txForm'),
      date: document.getElementById('date'),
      type: document.getElementById('type'),
      category: document.getElementById('category'),
      note: document.getElementById('note'),
      amount: document.getElementById('amount'),
      editId: document.getElementById('editId'),
      cancelEdit: document.getElementById('cancelEdit'),
      tableBody: document.querySelector('#txTable tbody'),
      visibleSum: document.getElementById('visibleSum'),
      month: document.getElementById('month'),
      search: document.getElementById('search'),
      kpiIncome: document.getElementById('kpiIncome'),
      kpiExpense: document.getElementById('kpiExpense'),
      kpiBalance: document.getElementById('kpiBalance'),
      catList: document.getElementById('categoryList'),
      exportBtn: document.getElementById('exportBtn'),
      importFile: document.getElementById('importFile'),
      resetBtn: document.getElementById('resetBtn'),
    exportCsvAllBtn: document.getElementById('exportCsvAllBtn'),
    };

    // ======= Category datalist =======
    function refreshCategories() {
      const cats = [...new Set(state.tx.map(t => t.category).filter(Boolean))].sort();
      el.catList.innerHTML = cats.map(c => `<option value="${c}"></option>`).join('');
    }

    // ======= CRUD =======
    function addOrUpdateTx(e) {
      e.preventDefault();
      const payload = {
        id: el.editId.value || uid(),
        date: el.date.value || new Date().toISOString().slice(0,10),
        type: el.type.value,
        category: el.category.value.trim() || 'Inne',
        amount: parseFloat(el.amount.value || '0'),
        note: el.note.value.trim(),
      };
      if (!isFinite(payload.amount)) return alert('Podaj prawidłową kwotę');
      if (payload.type === 'expense' && payload.amount > 0) payload.amount = -payload.amount;
      if (payload.type === 'income' && payload.amount < 0) payload.amount = Math.abs(payload.amount);

      const idx = state.tx.findIndex(t => t.id === payload.id);
      if (idx === -1) state.tx.unshift(payload); else state.tx[idx] = payload;
      save();
      refresh();
      el.form.reset();
      el.cancelEdit.style.display = 'none';
      el.editId.value = '';
    }

    function editTx(id) {
      const t = state.tx.find(x => x.id === id); if (!t) return;
      el.editId.value = t.id;
      el.date.value = t.date;
      el.type.value = t.type;
      el.category.value = t.category;
      el.amount.value = Math.abs(t.amount).toString();
      el.note.value = t.note || '';
      el.cancelEdit.style.display = 'inline-flex';
      el.date.focus();
    }

    function deleteTx(id) {
      if (!confirm('Usunąć transakcję?')) return;
      state.tx = state.tx.filter(t => t.id !== id);
      save();
      refresh();
    }

    // ======= Filters =======
    function matchFilters(t) {
      const m = el.month.value; // yyyy-mm
      const q = el.search.value.toLowerCase().trim();
      const okM = !m || (t.date && t.date.startsWith(m));
      const okQ = !q || (t.category + ' ' + (t.note||'')).toLowerCase().includes(q);
      return okM && okQ;
    }

    // ======= Render table & KPIs =======
    function renderTable() {
      const rows = state.tx.filter(matchFilters).map(t => `
        <tr>
          <td>${t.date || ''}</td>
          <td><span class="pill ${t.amount >= 0 ? 'income' : 'expense'}">${t.amount >= 0 ? 'Przychód' : 'Wydatek'}</span></td>
          <td>${t.category}</td>
          <td class="muted">${(t.note||'')}</td>
          <td class="right">${fmt(t.amount)}</td>
          <td class="right">
            <button class="btn btn-outline" onclick="editTx('${t.id}')">Edytuj</button>
            <button class="btn btn-danger" onclick="deleteTx('${t.id}')">Usuń</button>
          </td>
        </tr>`).join('');
      el.tableBody.innerHTML = rows || `<tr><td colspan="6" class="muted">Brak danych</td></tr>`;

      // Suma widocznych
      const sum = state.tx.filter(matchFilters).reduce((a, t) => a + t.amount, 0);
      el.visibleSum.textContent = fmt(sum);

      // KPI po miesiącu (jeśli wybrany) lub globalnie
      const base = el.month.value ? state.tx.filter(t => t.date && t.date.startsWith(el.month.value)) : state.tx;
      const income = base.filter(t => t.amount >= 0).reduce((a, t) => a + t.amount, 0);
      const expense = base.filter(t => t.amount < 0).reduce((a, t) => a + t.amount, 0);
      const balance = income + expense;
      el.kpiIncome.textContent = fmt(income);
      el.kpiExpense.textContent = fmt(Math.abs(expense));
      el.kpiBalance.textContent = fmt(balance);

      // Charts
      renderCharts(base);
      refreshCategories();
    }

    // ======= Charts =======
    let pieChart, barChart;
    function renderCharts(base) {
      const expByCat = base.filter(t => t.amount < 0).reduce((m, t) => {
        m[t.category] = (m[t.category] || 0) + Math.abs(t.amount);
        return m;
      }, {});
      const labels = Object.keys(expByCat);
      const values = Object.values(expByCat);

      const months = {};
      for (const t of base) {
        const key = (t.date||'').slice(0,7) || 'brak';
        months[key] = (months[key] || 0) + t.amount;
      }
      const mLabels = Object.keys(months).sort();

      if (pieChart) pieChart.destroy();
      if (barChart) barChart.destroy();

      const pieCtx = document.getElementById('pie');
      const barCtx = document.getElementById('bar');

      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: { labels, datasets: [{ data: values }] },
        options: { plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } } }
      });

      barChart = new Chart(barCtx, {
        type: 'bar',
        data: { labels: mLabels, datasets: [{ data: mLabels.map(k => months[k]) }] },
        options: {
          scales: { x: { ticks: { color: '#cbd5e1' } }, y: { ticks: { color: '#cbd5e1' } } },
          plugins: { legend: { display: false } }
        }
      });
    }

    // ======= Export / Import / Reset =======
    el.exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'budgetingapp-export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

     el.exportCsvAllBtn.addEventListener('click', () => {
    const rows = [
      ['data','typ','kategoria','opis','kwota','portfel','waluta'],
      ...state.tx.map(t => {
        const w = state.wallets.find(w=>w.id===t.walletId) || {};
        return [
          t.date||'',
          t.type==='income'?'przychód':'wydatek',
          t.category||'',
          String(t.note||'').replace(/\n/g,' '),
          String(t.amount ?? 0).replace('.', ','),
          w.name||'',
          w.currency||''
        ];
      })
    ];
    const csv = rows.map(r => r.map(v => '"' + String(v).replace(/"/g,'""') + '"').join(';')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = 'budgetingapp-wszystkie-portfele.csv';
    a.click(); URL.revokeObjectURL(a.href);
  });
 el.importFile.addEventListener('change', (e) => {
      const file = e.target.files?.[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (!data || !Array.isArray(data.tx)) throw new Error('Nieprawidłowy plik');
          state.tx = data.tx;
          save();
          refresh();
        } catch (err) { alert('Nie udało się zaimportować: ' + err.message); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    el.resetBtn.addEventListener('click', () => {
      if (!confirm('Na pewno usunąć wszystkie dane?')) return;
      state.tx = [];
      save();
      refresh();
    });

    // ======= Boot =======
    function refresh() { renderTable(); }
    load();
    // Prefill month to current
    const now = new Date();
    el.month.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    refresh();

    // ======= Form & filters bindings =======
    el.form.addEventListener('submit', addOrUpdateTx);
    el.cancelEdit.addEventListener('click', () => { el.form.reset(); el.editId.value=''; el.cancelEdit.style.display='none'; });
    el.month.addEventListener('input', refresh);
    el.search.addEventListener('input', refresh);

    // Expose for inline onclick
    window.editTx = editTx;
    window.deleteTx = deleteTx;
  </script>
</body>
</html>
